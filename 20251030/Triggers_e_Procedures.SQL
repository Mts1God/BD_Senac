-- Tabela de Vendas
CREATE TABLE VENDAS (
    id            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    produto       VARCHAR2(100) NOT NULL,
    categoria     VARCHAR2(50)  NOT NULL,
    valor         NUMBER(10,2)  NOT NULL CHECK (valor > 0),
    data_venda    DATE          DEFAULT SYSDATE,
    vendedor      VARCHAR2(100) NOT NULL
);

-- Tabela de Logs (para registrar todas as operações)
CREATE TABLE LOG_VENDAS (
    id            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    operacao      VARCHAR2(20)  NOT NULL,  -- INSERT, UPDATE, DELETE
    id_venda      NUMBER,
    produto       VARCHAR2(100),
    vendedor      VARCHAR2(100),
    valor         NUMBER(10,2),
    usuario       VARCHAR2(100) DEFAULT USER,
    data_hora     DATE          DEFAULT SYSDATE,
    observacao    VARCHAR2(500)
);

-- Inserir dados iniciais na tabela VENDAS
INSERT INTO VENDAS (produto, categoria, valor, data_venda, vendedor) 
VALUES 
    ('Notebook Dell', 'Eletrônicos', 4500.00, DATE '2025-04-01', 'Carlos'),
    ('Mouse Gamer', 'Acessórios', 150.00, DATE '2025-04-01', 'Ana'),
    ('Teclado Mecânico', 'Acessórios', 300.00, DATE '2025-04-02', 'Carlos'),
    ('Monitor 24"', 'Eletrônicos', 1200.00, DATE '2025-04-02', 'Bruna'),
    ('Fone Bluetooth', 'Acessórios', 200.00, DATE '2025-04-03', 'Ana'),
    ('Notebook HP', 'Eletrônicos', 4000.00, DATE '2025-04-03', 'Carlos'),
    ('Webcam HD', 'Acessórios', 180.00, DATE '2025-04-04', 'Bruna'),
    ('Carregador Portátil', 'Acessórios', 120.00, DATE '2025-04-04', 'Ana'),
    ('SSD 1TB', 'Componentes', 500.00, DATE '2025-04-05', 'Carlos'),
    ('Cabo HDMI', 'Acessórios', 50.00, DATE '2025-04-05', 'Bruna');

CREATE OR REPLACE TRIGGER trg_log_insert_vendas
AFTER INSERT ON VENDAS
FOR EACH ROW
BEGIN
    INSERT INTO LOG_VENDAS (
        operacao,
        id_venda,
        produto,
        vendedor,
        valor,
        usuario,
        data_hora,
        observacao
    ) VALUES (
        'INSERT',
        :NEW.id,
        :NEW.produto,
        :NEW.vendedor,
        :NEW.valor,
        USER,
        SYSDATE,
        'Nova venda inserida: ' || :NEW.produto || ' vendido por ' || :NEW.vendedor
    );
END;
/

-- Inserir uma nova venda (a trigger será executada automaticamente)
INSERT INTO VENDAS (produto, categoria, valor, vendedor)
VALUES ('Tablet Samsung', 'Eletrônicos', 1800.00, 'Ana');

COMMIT;

-- Verificar se o log foi criado automaticamente
SELECT * FROM LOG_VENDAS
ORDER BY data_hora DESC;

CREATE OR REPLACE PROCEDURE consultar_logs_vendedor
(
    p_vendedor IN VARCHAR2,
    p_total_logs OUT NUMBER
)
IS
BEGIN
    -- Contar quantos logs existem para o vendedor
    SELECT COUNT(*)
    INTO p_total_logs
    FROM LOG_VENDAS
    WHERE vendedor = p_vendedor;
    
    -- Exibir os logs do vendedor
    DBMS_OUTPUT.PUT_LINE('=== Logs de Vendas do Vendedor: ' || p_vendedor || ' ===');
    DBMS_OUTPUT.PUT_LINE('Total de registros: ' || p_total_logs);
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('ID | Produto | Valor | Data/Hora');
    DBMS_OUTPUT.PUT_LINE('-----------------------------------------------');
    
    -- Exibir cada log
    FOR registro IN (
        SELECT id_venda, produto, valor, TO_CHAR(data_hora, 'DD/MM/YYYY HH24:MI:SS') as data_formatada
        FROM LOG_VENDAS
        WHERE vendedor = p_vendedor
        ORDER BY data_hora DESC
    ) LOOP
        DBMS_OUTPUT.PUT_LINE(
            registro.id_venda || ' | ' ||
            registro.produto || ' | ' ||
            'R$ ' || registro.valor || ' | ' ||
            registro.data_formatada
        );
    END LOOP;
END consultar_logs_vendedor;
/

-- Habilitar exibição de mensagens
SET SERVEROUTPUT ON;

-- Declarar variável para receber o resultado
DECLARE
    v_total NUMBER;
BEGIN
    consultar_logs_vendedor('Ana', v_total);
    DBMS_OUTPUT.PUT_LINE('');
    DBMS_OUTPUT.PUT_LINE('Total retornado: ' || v_total);
END;
/

-- 1. Habilitar mensagens
SET SERVEROUTPUT ON;

-- 2. Inserir novas vendas (a trigger criará os logs automaticamente)
INSERT INTO VENDAS (produto, categoria, valor, vendedor)
VALUES ('Smartphone', 'Eletrônicos', 2500.00, 'Carlos');

INSERT INTO VENDAS (produto, categoria, valor, vendedor)
VALUES ('Mouse Pad', 'Acessórios', 80.00, 'Bruna');

COMMIT;

-- 3. Verificar os logs criados pela trigger
SELECT 
    id,
    operacao,
    produto,
    vendedor,
    valor,
    TO_CHAR(data_hora, 'DD/MM/YYYY HH24:MI:SS') AS data_hora
FROM LOG_VENDAS
ORDER BY data_hora DESC;

-- 4. Usar a procedure para consultar logs de um vendedor
DECLARE
    v_total NUMBER;
BEGIN
    consultar_logs_vendedor('Carlos', v_total);
END;
/


-- Habilitar mensagens DBMS_OUTPUT (no Oracle SQL Developer ou SQL*Plus)
SET SERVEROUTPUT ON;

-- Ver todas as triggers criadas
SELECT trigger_name, table_name, status
FROM user_triggers
WHERE table_name = 'VENDAS';

-- Ver todas as procedures criadas
SELECT object_name, object_type
FROM user_objects
WHERE object_type = 'PROCEDURE';

-- Desabilitar uma trigger temporariamente
ALTER TRIGGER trg_log_insert_vendas DISABLE;

-- Habilitar uma trigger novamente
ALTER TRIGGER trg_log_insert_vendas ENABLE;

-- Apagar uma trigger
DROP TRIGGER trg_log_insert_vendas;

-- Apagar uma procedure
DROP PROCEDURE consultar_logs_vendedor;


CREATE OR REPLACE TRIGGER trg_log_update_vendas
AFTER UPDATE ON VENDAS
FOR EACH ROW
BEGIN
    INSERT INTO LOG_VENDAS (
        operacao,
        id_venda,
        produto,
        vendedor,
        valor,
        usuario,
        data_hora,
        observacao
    ) VALUES (
        'UPDATE',
        :NEW.id,
        :NEW.produto,
        :NEW.vendedor,
        :NEW.valor,
        USER,
        SYSDATE,
        'Venda atualizada: ID=' || :NEW.id ||
        ', Produto de "' || :OLD.produto || '" para "' || :NEW.produto || '"' ||
        ', Valor de ' || :OLD.valor || ' para ' || :NEW.valor ||
        ', Vendedor de "' || :OLD.vendedor || '" para "' || :NEW.vendedor || '"'
    );
END;
/



-- Atualizar uma venda
UPDATE VENDAS
SET valor = 500.00, produto = 'Mouse Gamer Pro'
WHERE id = 2;

COMMIT;

-- Verificar o log criado
SELECT *
FROM LOG_VENDAS
WHERE operacao = 'UPDATE'
ORDER BY data_hora DESC;

CREATE OR REPLACE PROCEDURE total_vendas_vendedor
(
    p_vendedor IN  VARCHAR2, 
    p_total    OUT NUMBER
)
IS
BEGIN
    -- Calcula o total de vendas do vendedor
    SELECT NVL(SUM(valor), 0)
    INTO p_total
    FROM VENDAS
    WHERE vendedor = p_vendedor;
END;
/


DECLARE
    v_total NUMBER;
BEGIN
    -- Chamar a procedure passando o vendedor
    total_vendas_vendedor('Carlos', v_total);
    
    -- Exibir o resultado
    DBMS_OUTPUT.PUT_LINE('Total de vendas do Carlos: R$ ' || v_total);
END;
/

CREATE OR REPLACE TRIGGER trg_valida_valor_venda
BEFORE INSERT ON VENDAS
FOR EACH ROW
BEGIN
    IF :NEW.valor <= 0 THEN
        RAISE_APPLICATION_ERROR(-20001, 'Erro: o valor da venda deve ser maior que zero.');
    END IF;
END;
/


-- Tentativa de inserir uma venda inválida
INSERT INTO VENDAS (produto, categoria, valor, vendedor)
VALUES ('Mouse Invalido', 'Acessórios', 0, 'Ana');
